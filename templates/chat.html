{% extends "grid.html" %} {% block title %} {{flow}} {% endblock %} {% block js
%}
<script type="text/javascript">
    var base_url = "";
    var base_delay = 1500;

    async function fetchString() {
        try {
            var url =
                window.location.origin +
                window.location.pathname +
                "fetch_string";
            const startTime = performance.now();
            const response = await fetch(url);
            const data = await response.json();
            const endTime = performance.now();
            const executionTime = endTime - startTime;
            console.log("time to parse string");
            const cstatus = JSON.parse(data.fetched_string);
            console.log("parsed string succesfully");
            console.log(JSON.stringify(cstatus.meta, null, 2, false));
            if (!cstatus.reply) {
                console.log("done");
                document.querySelector(".grid-container").action =
                    "{{ url_for('dispatcher', done=1)}}";
                document.querySelector(".grid-container").submit();
            }

            base_delay = base_delay - executionTime;
            if (base_delay < 0) base_delay = 0;

            setTimeout(
                () =>
                    (document.querySelector(".message").innerHTML =
                        cstatus.reply),
                base_delay,
            );
        } catch (error) {
            console.error("Error:", error);
        } finally {
            setTimeout(
                () =>
                    document
                        .querySelector(".message")
                        .classList.remove("loader"),
                base_delay,
            );

            document.querySelector(".confirm").classList.remove("hide");
            document.querySelector(".abort").classList.remove("hide");
            start_time = Date.now();
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        fetchString();
        document.querySelectorAll(".avatar").forEach((avatar) => {
            avatar.classList.remove("hide");
        });
        document.querySelector(".message").classList.add("loader");
        document.querySelector(".message").innerHTML = "";
        document.querySelector(".user-input").classList.remove("hide");
        document.querySelector(".user-input").name = "answer";
    });

    document.querySelector(".abort").addEventListener("click", () => {
        document.querySelector(".grid-container").action =
            "{{ url_for('dispatcher', abort=1)}}";
    });

    const reaction_ms = document.querySelector("#reaction-ms");

    document
        .querySelector(".grid-container")
        .addEventListener("submit", function () {
            reaction_ms.value = Date.now() - start_time;
        });
</script>

{% endblock %}
